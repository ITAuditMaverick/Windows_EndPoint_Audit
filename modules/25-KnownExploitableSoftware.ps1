. "$PSScriptRoot\..\utils\Add-AuditResult.ps1"

try {
    $cveList = @("7-Zip", "WinRAR", "Adobe Flash", "Java 8")

    $regPaths = @(
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*",
        "HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
    )

    $installedApps = @()

    foreach ($path in $regPaths) {
        $apps = Get-ItemProperty -Path $path -ErrorAction SilentlyContinue | Where-Object {
            $_.PSObject.Properties.Name -contains "DisplayName"
        }

        foreach ($app in $apps) {
            if ($app.DisplayName) {
                $installedApps += $app.DisplayName
            }
        }
    }

    $matches = $installedApps | Where-Object {
        $cveList | ForEach-Object { $appName = $_; $_ -and $_ -ne "" -and $_ -eq $appName }
    }

    if ($matches.Count -gt 0) {
        $risk = "High"
    } else {
        $risk = "Low"
    }

    Add-AuditResult -Category "Known Exploits" `
                    -CheckName "Potentially Vulnerable Software" `
                    -Value (($matches -join ', ') -replace '^$', 'None Found') `
                    -Risk $risk `
                    -Justification "Known vulnerable software was identified." `
                    -Remediation "Remove or update software to secure versions." `
                    -ISO27001 "8.29" `
                    -NIST80053 "SI-2" `
                    -NISTCSF "PR.IP-12"
}
catch {
    Add-AuditResult -Category "Known Exploits" `
                    -CheckName "Potentially Vulnerable Software" `
                    -Value "Error: $_" `
                    -Risk "Medium" `
                    -Justification "Failed to enumerate installed software." `
                    -Remediation "Ensure script has registry access and run with appropriate privileges." `
                    -ISO27001 "8.29" `
                    -NIST80053 "SI-2" `
                    -NISTCSF "PR.IP-12"
}
